<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>p5.js and Xebra</title>
  <style>
    html, body {
      margin: 0;
    }
  </style>
  <script src="../../dist/xebra.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.5.4/p5.min.js"></script>
  <script src="../js/lib/boid.js"></script>
</head>
<body>
  <script>
    var boids = [];
    var sketchFrame;
    var frameRect;
    var scaleSketch = 1.5;

    function setup() {
      connectXebra();
      frameRate(30);
    }

    function draw() {
      background(51);
      for (var i = 0; i < boids.length; i++) {
        boids[i].run(boids);

        //set position of connected button
        var object = sketchFrame.getObject(boids[i].id);
        var xPos = frameRect[0] + boids[i].position.x/scaleSketch;
        var yPos = frameRect[1] + boids[i].position.y/scaleSketch;

        var buttonRect;
        if (sketchFrame.viewMode === Xebra.VIEW_MODES.PRESENTATION) {
          buttonRect = object.getParamValue("presentation_rect");
          object.setParamValue("presentation_rect",[xPos - buttonRect[2]/2, yPos - buttonRect[3]/2, buttonRect[2], buttonRect[3]]);
        } else {
          buttonRect = object.getParamValue("patching_rect");
          object.setParamValue("patching_rect",[xPos - buttonRect[2]/2, yPos - buttonRect[3]/2, buttonRect[2], buttonRect[3]]);
        }
      }
    }

    function connectXebra() {
      var options = {
        hostname : "127.0.0.1", // localhost
        port : 8086,
        supported_objects : Xebra.SUPPORTED_OBJECTS
      };

      var xebraState = new Xebra.State(options);

      xebraState.on("frame_added", function(frame) {
        sketchFrame = frame;
        if (frame.viewMode === Xebra.VIEW_MODES.PRESENTATION) {
          frameRect = frame.getParamValue("presentation_rect"); 
        } else {
          frameRect = frame.getParamValue("patching_rect");
        }
        createCanvas(frameRect[2]*scaleSketch, frameRect[3]*scaleSketch);
        background(51);
      });

      xebraState.on("object_added", function(object) {
        if (object.type === "button") {
          boids.push(new Boid(random(width), random(height), object._id));
        }
      });

      // Do something when a slider is removed
      xebraState.on("object_removed", function(object) {
        console.log('object removed!');
      });

      xebraState.on("object_changed", function(object, type, value) {
        if (object.type === "button") {
          // console.log('button changed!');
        }
      });

      xebraState.connect();
    }
  </script>
</body>
</html>